!function(){var a={max_undo:20,undoChange:function(){},redoChange:function(){}},b=function(a){this.action_index={},this.next_id=1,this.undo_queue=[],this.redo_queue=[],this.current_action=null,this.group=null,this.group_queue=[],this.group_id=0,this.working="",this.undo_available=0,this.undo_names=[],this.redo_available=0,this.redo_names=[],this.changeSettings(a)};b.prototype.changeSettings=function(b){this.settings=a;for(attrname in b)b.hasOwnProperty(attrname)&&(this.settings[attrname]=b[attrname]);this.settings=$.extend(a,b)},b.prototype.groupRunner=function(a){for(var b;b=a.pop();){var c=this.action_index[b];delete this.action_index[b],c[1].apply(c[3],c[2])}},b.prototype.undoable=function(a,b,c,d,e,f){if(null!==this.group)return e=e||this.next_id++,this.action_index[e]=[a,b,c,d],this.group[2][0].push(e),this;var g=this.undo_queue;return"UNDO"==this.working&&(g=this.redo_queue),e=e||this.next_id++,this.action_index[e]=[a,b,c,d],f||(g.push(e),g.length>this.settings.max_undo&&(g.shift(),"UNDO"==this.working?(this.redo_available--,this.redo_names.shift()):(this.undo_available--,this.undo_names.shift())),"UNDO"==this.working?(this.redo_available++,this.redo_names.push(this.current_action[0]),this.settings.redoChange()):(this.undo_available++,"REDO"==this.working?this.undo_names.push(this.current_action[0]):(this.clearRedoQueue(),this.undo_names.push(a)),this.settings.undoChange())),this},b.prototype.undo=function(){if(this.undo_queue.length>0){var a=this.undo_queue.pop();this.undo_available--,this.undo_names.pop();var b=this.action_index[a];delete this.action_index[a],this.working="UNDO",this.current_action=b,this.startGroup(b[0]),b[1].apply(b[3],b[2]),this.endGroup(),delete this.current_action,this.working="",this.settings.undoChange()}return this},b.prototype.clearUndoQueue=function(){for(var a=this.undo_queue.length-1;a>=0;a--)delete this.action_index[this.undo_queue[a]];return this.undo_queue=[],this.undo_available=0,this.redo_names=[],this.settings.undoChange(),this},b.prototype.clearQueues=function(){return this.action_index={},this.undo_queue=[],this.undo_available=0,this.undo_names=[],this.redo_queue=[],this.redo_available=0,this.redo_names=[],this.settings.undoChange(),this.settings.redoChange(),this},b.prototype.redo=function(){if(this.redo_queue.length>0){var a=this.redo_queue.pop();this.redo_available--,this.redo_names.pop();var b=this.action_index[a];delete this.action_index[a],this.working="REDO",this.current_action=b,this.startGroup(b[0]),b[1].apply(b[3],b[2]),this.endGroup(),delete this.current_action,this.working="",this.settings.redoChange()}return this},b.prototype.clearRedoQueue=function(){for(var a=this.redo_queue.length-1;a>=0;a--)delete this.action_index[this.redo_queue[a]];return this.redo_queue=[],this.redo_available=0,this.redo_names=[],this.settings.redoChange(),this},b.prototype.startGroup=function(a){return null!==this.group&&this.group_queue.push(this.group),this.group_id=this.next_id++,this.group=[a,this.groupRunner,[[]],this,this.group_id],this.group_id},b.prototype.endGroup=function(){var a=this.group;return this.group_queue.length>0?this.group=this.group_queue.pop():this.group=null,this.undoable.apply(this,a),this},b.prototype.exitGroup=function(a){if(a!==!1){var b=this.group;this.startGroup("rolling back"),b[1].apply(b[3],b[2]),this.exitGroup(!1)}return this.group_queue.length>0?this.group=this.group_queue.pop():this.group=null,this},b.prototype.resumeGroup=function(a){return null!==this.group&&this.group_queue.push(this.group),this.group=this.action_index[a],this.group[5]=!0,this.group_id=a,this},window.UndoManager=b}();